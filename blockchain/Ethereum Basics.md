# 以太坊基础知识


我目前的认识：

- **以太坊区块链是一台去中心化计算机，可以运行任何图灵完备的程序（合约），对合约的每次访问都被看作一次链上交易**
- 运行在以太坊区块链上的合约，是永远不会宕机的程序，天生就是分布式的
- 交易需要付给矿工一定的小费（Gas），可以通过增加小费来加速交易
    - 目前感觉 Gas 是真的贵


## 交易

交易由外部账户发起，由以太坊网络传输，并记录在以太坊区块链上。
交易是唯一改变以太坊区块链状态、或者执行一个合约的方法。


交易的结构：

- Nonce: 由外部账户生成的一个序列号
  - 两个用途：一是避免交易被重复提交，二是确保区块链会按提交顺序处理交易（避免后提交的交易反而先被执行）
- Gas 价格: 用户愿意付的 Gas 单价（以 Ether Wei 为单位）
- Gas 上限：用户愿意为此次交易付出的最大 Gas 数量
- Recipient: 接受者的以太坊地址
- Value: 发送给接收者的 Ether 数量（以 Ether Wei 为单位）
- Data: 变长二进制数据，主要用于提交合约参数
- v,r,s: 外部账户 ECDSA 签名的三个部分
  - 从 v,r,s 中可以推导出外部账户的公钥，进而派生出账户 ID，因此交易中不单独记录外部账户的 ID


### Gas

Gas 就是付给矿工的小费。
其目的，一是提升矿工的积极性，使他们愿意为以太坊贡献算力；二是用于计量合约的执行时间，避免死循环合约无法停止、平白浪费区块链中的算力。

Gas 跟 Ether 是分离的，有一个汇率在中间。这是为了避免 Ether 价格的剧烈波动影响到 Gas.

用户需要在交易中设定愿意付出的 Gas 单价，出价越高，矿工们就越愿意处理你的交易，交易速度就越快。

<https://ethgasstation.info/> 这个站点显示了当前市场上的 Gas 汇率以及对应的交易速度。

以太坊允许将交易中的 Gas 单价设置为 0，但是这可能会导致你的交易永远不会被处理。

而交易中的 GasLimit，是你愿意为此次交易付出的 Gas 数量的上限。
对于普通的转账交易，Gas Limit 的值固定为 21000. 而如果交易对象是一个合约，那就要看合约具体会执行多久了，程序导致要跑多久是很难估算的，通常你发起交易的时候你的钱包客户端（如 metamask）会给出一个预估值，但是不一定准确。

因此能看到，GasLimit 其实是专为合约设计的。
矿工跑合约时是按实际用量收费的，如果运行费用没超过 GasLimit 那自然是用了多少就扣你多少；
如果合约运行的费用超过了限制，矿工会立即停止执行，并将交易标记为失败，同时会从你的账户中扣掉 GasPrice * GasLimit 这么多的 Ether Wei. 注意即使运行失败也会扣钱哈！毕竟矿工已经出了力了。

### 交易接收地址

接收地址可以是一个任意的 20bytes 以太坊地址。
如果这个地址目前不存在，交易仍然是有效的，只是谁也收不到这个钱，可以认为这个钱就被销毁了。
所以说交易一定要谨慎，安全起见可以先转一点点钱过去确认下！

### Value 跟 Data

Data 主要是给合约用的，Value 则可用于合约或者外部账户之间的转账。

如果一个合约要允许接收 Ether，它必须声明自己为 payable 的，并且提供对应的 receive 函数。


### 特殊交易 - 创建合约

创建合约是一个特殊的交易，这个交易的接收地址必须为 `0x0`，这个地址既不是外部账户也不是合约，它只是一个特殊符号，用于表示「创建合约」这个动作。

将 Ether 发送给 `0x0` 也能达到销毁 Ether 的目的，但是通常更建议使用 `0x000000000000000000000000000000000000dEaD` 来实现这个目的，这是一个专门用于销毁 Ether 的地址。


### 交易的传输与记录

以太坊的节点之间通过 P2P 网络互联，当用户提交一个交易到某个节点时，这个节点首先会将交易发送给它的邻居节点（至少有 13 个这样的节点），邻居节点验证其有效后，会将其广播到它的其他邻居节点，这样最终这项交易就记录在整个区块链中了。

当交易被记录之后，下一步就是矿工来执行了，各位矿工会尝试通过 PoW 算法抢先完成交易的记录或者合约的执行，并广播到整个区块链中，最先完成记录的矿工将获得对应的 Gas 奖励。


### 多签名交易

比特币中也存在这样的多签名账户：只有该账户的所有持有者都对其签名后，这项交易才有效。

然而以太坊并不直接提供此项功能，它鼓励用户通过合约编程来实现多签名账户相同的能力。但是这被诟病的一点是，合约写得不好就会有安全隐患（2017 年以太坊的多签名钱包漏洞造成价值 2.8 亿美元的以太币被冻结），而比特币的多签名账户已经经过多年验证是安全的。


## 智能合约与 Solidity

「智能合约」是指在去中心化以太坊虚拟机上运行的不可变程序，并且要注意到以太坊虚拟机实际上是一个单线程的计算机，不会存在并发执行的合约。

合约的一大特点是它是公开的且不可变的，因为它被存储在区块链上。
这导致合约不可能被修改，要修 bug 只能创建新的合约，但是这会导致所有用户都需要使用新的合约地址，所以说合约的修改就变得非常困难。


### 删除合约

合约不可变，但是可以被声明为「可删除」。

如果合约被声明为可删除，就可以通过发起一个交易，在 EVM 上执行 `SELFDESTRUCT` 命令删除掉该合约。
删除合约的交易会产生「负 Gas」，也就是退款，这是为了鼓励用户删除掉它不使用的合约。

删除合约只会删除其代码，但是所有的交易历史是不可删除的。

## 混合智能合约

通常一个智能合约，既需要在区块链上执行，同时又需要区块链之外，真实世界的数据，比如 Visa/PayPal 交易信息、IPFS 数据存储、或者执行在线上执行某些计算，等等。


Chainlink - 去中心模块化的预言网络（Decentralized Modular Oracle Network）




## Tokens 代币

代币是指在某些特定场景下，具有特定价值的一种货币。
比如游戏厅的游戏币，QQ 中的 Q 币等等，各种现实中的特殊硬币或者网络上的虚拟代币。

而以太坊上的代币，则是在区块链上的实现的一种代币机制。
它跟以太币的区别是，任何公司都可以在以太坊上发行自己的代币，比如腾讯就可以在以太坊上发行「以太坊 Q 币」。



代币有很多种类型：

- ERC-20
- ERC-721
- ERC-1155

## 预言机 Oracles

在本章中，我们将讨论预言机 Oracles，它们是可以为以太坊智能合约提供外部数据源的系统。
「预言」一词来自希腊神话，指与众神交流的人，可以看到未来的景象。
在区块链的背景下，预言机是一个可以回答以太坊外部问题的系统。理想情况下，预言机是无需信任的系统，这意味着它们不需要被信任，因为它们按照去中心化原则运行。


## 共识

TBD


## 其他概念


NFT

DeFi

DAO

分布式存储：

- IPFS/SWARM



路线图：

- https://github.com/OffcierCia/DeFi-Developer-Road-Map


中文书籍：
- https://github.com/yeasy/blockchain_guide
