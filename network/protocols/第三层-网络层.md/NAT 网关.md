# NAT 网关

NAT，即 Network Address Translation，是 IPv4 网络中非常重要的一个功能，用于执行 IP 地址与端口的转换。

IPv4 的设计者没预料到因特网技术的发展会如此之快，在设计时只使用了 32bits 的地址空间，随着因特网的飞速发展，它很快就变得不够用了。
后来虽然设计了新的 IPv6 协议，但是它与 IPv4 不兼容，需要新的硬件设备以及各种网络程序支持，无法快速普及。

NAT 就是在 IPv6 普及前，临时解决 IPv4 地址空间不够用而开发的技术，有网友戏称 NAT 就是用来给 IPv4 续命的。它解决 IPv4 地址短缺问题的方法是：

- 每个家庭、组织、企业，在内部都使用通用的私有 IP 地址进行通讯。不同的家庭、组织、企业，都可以使用相同的私有 IP 地址段，不会互相影响
  - 路由器通过 DHCP 为局域网中的设备分配私有 IP 地址
  - 在局域网内部，路由器使用适用于局域网的路由算法进行数据路由。比如 OSPF.
- 在局域网与上层网络的交界处（路由器），使用 NAT 技术进行 IP/port 转换，使用户能正常访问上层网络。

在曾经 IPv4 地址还不是特别短缺的时候，普通家庭的网络架构通常是：「家庭局域网」=>「NAT 网关（家庭路由器）」=>「因特网」。

但是互联网主要发展于欧美，因此许多欧美的组织与机构在初期被分配了大量的 IPv4 资源，而后入场的中国分配到的 IPv4 地址就不太能匹配上我们的人口。
因此相比欧美，中国的 IPv4 地址是非常短缺的，即使使用上述这样的网络架构——也就是给每个家庭（或组织）分配一个 IPv4 地址——都有点捉襟见肘了。
于是中国电信等运营商不得不再加一层 NAT，让多个家庭共用同一个 IP 地址，这时网络架构会变成这样：「家庭局域网」=>「NAT 网关（家庭路由器）」=>「广域网（由 ISP 管理）」=>「NAT 网关」=>「因特网」。

不过总的来说，NAT 仍然是一项非常成功的技术，它成功帮 IPv4 续命了几十年，甚至到如今 2022 年，全球网络仍然是 IPv4 的天下。

## NAT 如何工作

NAT 的工作方式，使用图例描述是这样的：

![](./imgs/NAT-demo.png)

从外部网络看一个 NAT 网关（一个启用了 NAT 的路由器），它只是拥有一个 IPv4 地址的普通设备，所有从局域网发送到公网的流量，其 IP 地址都是这个路由器的 WAN IP 地址，在上图中，这个 IP 地址是 `138.76.29.7`.

本质上，NAT 网关隐藏了家庭网络的细节，从外部网络上看，整个家庭网络就像一台普通的网络设备。

NAT 网关会维护一个 NAT 翻译表，它负责记录 IP/port 的映射关系。

因此可以看到 NAT 实际上会使用传输层的端口信息，这说明它同时工作在 L3 网络层与 L4 传输层上，并不是一项纯粹的 L3 技术。

## NAT 的地址映射方式

### 1. 一对一 NAT

一对一 NAT，也被称为 Basic NAT，在 [RFC2663](https://datatracker.ietf.org/doc/html/rfc2663#section-4.0) 中被定义，在技术上比较简单，只利用网络层的信息，对 IP 地址进行转换。

简单的说，Basic NAT 要求每个内网 IP 都需要绑定一个唯一的外网 IP，才能连通外部网络。
通常路由器只有一个 IP，这种场景下 Basic NAT 只允许同时有一台内网主机访问外部网络。

Basic NAT 有两种类型：「静态 NAT」与「动态 NAT」。

现在的很多家庭路由器都自带一个被称为 DMZ 主机的功能，它是「Demilitarized Zone」的缩写，意为隔离区。
它允许将某一台内网主机设置为 DMZ 主机（或者叫隔离区主机，仅此主机可供外网访问），所有从外部进来的流量，都会被通过 Basic NAT 修改为对应的内网 IP 地址，然后直接发送到该主机。
路由器的这种 DMZ 技术就是「静态 NAT」，因为 DMZ 对应的内网 IP 需要手动配置，不会动态变化。

而「动态 NAT」则需要路由器维护一个公网 IP 地址池，内网服务器需要访问公网时，动态 NAT 就从地址池中拿出一个公网 IP 给它使用，用完再回收。
这种场景需要一个公网 IP 地址池，我就没接触过了，应用场景或许主要是某些数据中心。

Basic NAT 的好处是，它仅工作在 L3 网络层，网络层上的协议都可以正常使用（比如 P2P），不需要啥「内网穿透」技术。 

### 2. 一对多 NAT

一对多 NAT，也被称为 NAPT（network address and port translation），同样在 [RFC2663](https://datatracker.ietf.org/doc/html/rfc2663#section-4.0) 中被定义。

**绝大多数的 NAT 网络都是 NAPT**，原因应该很好理解——一对一 NAT 的局限性太大，静态 NAT 需要手动配置，动态 NAT 的并发会话数也受公网 IP 的数量限制。

NAPT 通过同时利用 L3 的 IP 信息，以及 L4 传输层的端口信息，来为局域网设备提供透明的、配置方便的、支持超高并发连接的外部网络通信。

NAPT 的端口分配与转换，以及对外来流量的处理，有四种不同的策略，我们在下面逐一介绍。

NAT 通常在路由器上实现，一些高端路由器可以支持自定义 NAPT 的类型，但是大多数家庭路由器都不支持这项功能。

#### 1. Full-cone NAT

Full-cone NAT 也叫一对一 NAPT（注意跟前面的 Basic NAT 别混淆了），它的特点如下：

- 数据包流出：一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。
- 数据包流入：任意主机发送到 eAddr:ePort 的数据包，都能通过 NAT 到达 iAddr:iPort.
  - 也就是不对外部进来的数据做任何限制，全部放行。

允许任意主机发送到 eAddr:ePort 的数据到达内部地址是很危险的行为，因为内部主机不一定配置了合适的安全策略。
因此 **Full-cone NAT 应该非常少见**，至少我没遇到过。

#### 2. Address-Restricted cone NAT

- 数据包流出：（跟 Full-cone NAT 完全一致）一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。
- 数据包流入：只有内部地址（iAddr:iPort）主动连接过的外部主机（nAddr:any），发送到 eAddr:ePort 的数据包，才能通过 NAT 到达 iAddr:iPort.
  - **跟 Full-cone NAT 的区别在于，它限制了外部主机的 IP 地址。只有主动连接过的主机，才能发送数据到 NAT 内部。这提升了一些安全性**。

#### 3. Port-Restricted cone NAT

- 数据包流出：（跟 Full-cone NAT 完全一致）一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。
- 数据包流入：只有内部地址（iAddr:iPort）主动连接过的外部主机（nAddr），通过一个指定的端口 hPort 发送到 eAddr:ePort 的数据包，才能通过 NAT 到达 iAddr:iPort.
  - **与 Address-Restricted cone NAT 的区别在于，它同时限制了外部主机的 IP 与端口，可以说是更进一步地提升了安全性。**

#### 4. Symmetric NAT

- 数据包流出：每个内部地址（iAddr:iPort）都映射到一个唯一的外部地址（eAddr:ePort）。同一个内部地址与不同的外部地址的通信，会使用不同的 NAT 端口。
- 数据包流入：只有内部地址（iAddr:iPort）主动连接过的外部地址（nAddr:nPort），可以给这个内部地址回消息。

**对称 NAT 是最安全的一种 NAT 结构，限制最为严格，应该也是应用最广泛的 NAT 结构**。
但是它导致所有的 TCP 连接都只能由从内部主动发起，外部发起的 TCP 连接请求会直接被 NAT 拒绝，因此它也是 P2P 玩家最头疼的一种 NAT 类型。
解决方案是通过 UDP 迂回实现连接的建立，我们会在后面讨论这个问题。

##### 对称 NAT 允许的最大并发 TCP 连接数是多少？

TCP 并发连接数受许多参数的限制，以 Linux 服务器为例，默认参数无法满足需要，通常都会手动修改它的参数，放宽文件描述符限制以及 TCP 连接队列、缓存相关的限制。

单纯从网络协议层面分析，对于一个仅有一个公网 IP 的 Symmetric NAT 网关，它与某个外部站点 `http://x.x.x.x:xx` 要建立连接。
考虑到 TCP 连接的定义实际上是一个四元组 `(srcIP, srcPort, dstIP, dstPort)`，其中就只有 NAT 网关自己的 `srcPort` 是唯一的变量了，而端口号是一个 16bits 数字，取值范围为 0 - 65535。
此外低于 1024 的数字是操作系统的保留端口，因此 NAT 一般只会使用 1024-65535 这个区间的端口号，也就是说这个 NAT 网关最多只能与该站点建立 64512 个连接。

那么对于不同的协议 NAT 是如何处理的呢？NAT 肯定可以通过协议特征区分不同协议的流量，因此不同协议通过 NAT 建立的并发连接不会相互影响。

对于家庭网络而言 64512 个连接已经完全够用了，但是对于数据中心或者云上的 VPC 而言，就不一定够用了。
举个例子，在 [AWS NAT 网关的文档](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html)中就有提到，AWS NAT 网关最高支持与每个不同的地址建立 55000 个并发连接。destination 的 IP 地址、端口号、(TCP/UDP/ICMP) 任一个发生改变，都可以再建立其他 55000 个并发连接。
如果超过这个限制，就会发生「ErrorPortAllocation」错误。如果在 AWS 上遇到这个错误，那就说明你们的云上网络规划有问题了。

当然除了端口限制外，受限于 NAT 硬件、以太网协议以及其他影响，NAT 网关肯定还有包处理速率、带宽的限制，这个就略过不提了。

## 缺陷

连接只能从 NAT 内部发起，这导致许多 P2P 协议都无法使用。
常见的比如 bittorrent 协议，没有公网 IP 就玩不了。

## 应用

NAT 技术被广泛应用在家庭局域网、Docker 虚拟网络、Kubernetes 虚拟网络、云服务的虚拟网络、广域网等非常多的场景中。

使用 NAT 的目的有：

- 隔离与安全性：NAT 与外部网络天然隔离，连接只能从内部主动发起。
- 省钱：局域网内的设备都不需要分配公网 IP，要知道在 IPv4 地址短缺的现在，IP 地址可是很精贵的。
- 搭建虚拟网络：基于物理网络搭建虚拟网络


## 如何穿透 NAT

天下苦 NAT 久矣，尤其是各种 P2P 玩家。那么到底有哪些技术手段可以用来穿透 NAT 呢？这里就来聊一聊。

最简单的方法是 DMZ 主机功能，它直接给内网服务器绑定路由器的外部 IP，它的缺点是只能将一台主机提供给外网访问，而且将整台主机开放到公网实际上是很危险的，如果不懂网络很容易被黑客入侵。

那退一步，可以直接用端口转发功能，就是手动设置路由器某个端口号的所有 TCP/UDP 流量，都直接 NAT 转发到到内网的指定地址。
NAS 发烧友们想玩 P2P 下载分享，基本都是这么做的。

更进一步，我觉得手动配端口号太麻烦，我需要更动态的 NAT 端口转发策略，怎么办呢？可以看下你的浏览器是否支持 uPnP(Universal Plug and Play) 协议，如果支持，内网设备就可以通过 uPnP 向路由器动态申请一个端口号供其使用，uPnP 会自动配置对应的端口转发规则。现在新出的路由器基本都支持 uPnP 功能。

## Docker 与 NAT

Docker 容器网络基于 iptables 实现了自己的虚拟网络，并且通过 NAT 与外部网络通信。

TODO


## AWS VPC 与 NAT

默认路由到 NAT 的是私有子网（或者没默认路由，那就是无法访问公网的私有子网），连接只能由内网程序主动发起。

默认路由到 IGW 的是公有子网。

TODO
