# 多云场景下的负载均衡方案调研

几乎所有的云厂商都直接提供了自家的 L4/L7 层负载均衡服务，而且提供的 API 各有区别。

此外市场上也有若干开源的 L4/L7 层负载均衡，对负载均衡而言最常用的高可用方案是 Keepalived.

那么是用开源组件自建负载均衡合适，还是应该直接使用云厂商提供的负载均衡服务呢？
如果考虑到迁移到多云的可能性，又该如何选择负载均衡服务呢？
本文的主要目的就是回答这两个问题。


## 一、L7 层负载均衡 - API 网关

>https://landscape.cncf.io/card-mode?category=api-gateway&grouping=category

在 Kubernetes 流行的现在，K8s 集群内部的 L7 层负载均衡是必不可少的，它还得拥有按各种规则进行负载均衡、流量切分、流量镜像的能力，目前绝大多数 K8s 中的 APIGateway 都是基于 Envoy/Nginx 实现的。

Envoy 系列网关：

- Istio IngressGateway: 我们当前使用的方案
- Contour
- github.com/emissary-ingress/emissary
- 

除了 Envoy 系列，另外还有一个基于 Ngninx/Openresty 实现的 APIGateway，代表作是两个：

- APISIX
- Kong

其他 API 网关：

- github.com/megaease/easegress
- https://github.com/apioak/apioak
- https://github.com/luraproject/lura
- https://github.com/TykTechnologies/tyk
- https://github.com/alibaba/Sentinel

内部有了 Envoy 进行 L7 负载均衡后，外部还需要一个 L4 负载均衡，用于实现在所有 Envoy 网关 Pods 上进行请求的负载均衡，而这个 L4 负载均衡的选择，参见下一节。

对于多集群的情况，需要分情况讨论：

- 多个集群完全等价，或者不等价但是只需要基于域名做流量分配：
  - 这种情况，可以直接使用**基于 DNS 的加权解析**，调整不同域名的集群间的流量分配。
- 多个集群不等价，而且需要基于域名 + HTTP Path 进行负载均衡
  - 需要一个**外部 L7 负载均衡**来决定流量如何在集群间分配

实际使用中，可以结合使用上述两种方案，优先选择使用 DNS 实现集群间流量分配，只在必须借助 HTTP Path 的场景下才走**外部 L7 负载均衡**。

集群外 L7 负载均衡的选择：

- https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/high-availability-keepalived/
- ...

此外还有 AWS Marketplace 中的其他 L4/L7 供应商：

- [Citrix ADC on AWS](https://www.citrix.com/global-partners/amazon-web-services/citrix-adc-on-aws.html)
- [Avi - The Multi-Cloud Application Services Platform - VMware 子公司](https://avinetworks.com/)
  - [多云负载均衡 - Avi Networks](https://www.vmware.com/cn/solutions/load-balancing.html)
- [Load Balancer Enterprise ADC](https://aws.amazon.com/marketplace/pp/prodview-pl3bajfqqk5qq)
- [Kemp Load Balancer ADC - BYOL](https://aws.amazon.com/marketplace/pp/prodview-6ltd3y2c6pggk)
- [Apache APISIX on APISEVEN Platform](https://aws.amazon.com/marketplace/pp/prodview-q5o4ctojdvevu)

其他多云管理方案：

- [多云管理与 CloudFlare](https://www.cloudflare.com/zh-cn/learning/cloud/what-is-multicloud-management/)
- [应用交付控制器 - ADC 解决方案 - 速石科技](https://fastonetech.com/adc)
- [面向编程式多云管理服务时代的华为云 MCP 多云跨云的容器治理与实践](https://xie.infoq.cn/article/71f92d93350ca2fb95f74da2f)
- [F5’s Multi-Cloud Networking Strategy and the Gartner 2021 Cool Vendors in Cloud Computing Report](https://www.f5.com/company/blog/multi-cloud-gartner-cool-vendor-cloud-computing-report)
- [Market Guide for Multicloud Networking Software](https://aviatrix.com/gartner-multicloud-networking-software-market-guide/)
  - [Multicloud Networking Software (MCNS)](https://blogs.gartner.com/andrew-lerner/2022/04/21/multicloud-networking-software-mcns/)


## 二、L4 层负载均衡


可选项：

- https://www.haproxy.com/blog/haproxy-on-aws-best-practices-part-3/
- https://github.com/facebookincubator/katran
- https://github.com/iqiyi/dpvs: 爱奇艺开源的方案，但是项目不活跃了


## 四、负载均衡的高可用

最常见的负载均衡高可用，都是裸机方案，基于 Keepalived 实现。

在云上通常大家就直接使用云服务商提供的 LB 服务了，因此需求不高。

不过云服务商也确实提供了对应的能力，以 AWS 为例，我们接下来研究下如何使用 Keepalived + GWALB 实现自建负载均衡的高可用。


